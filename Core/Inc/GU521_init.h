// GU521_init.h
#ifndef GU521_INIT_H
#define GU521_INIT_H

#include "stm32f4xx.h"
#include <stdint.h>

/**
 * @brief  Полная инициализация I2C1 на PB8/PB9 для работы с MPU6050.
 *
 * Функция:
 *   - корректно настраивает GPIO;
 *   - задаёт временные параметры I2C Standard Mode (100 kHz);
 *   - включает ACK;
 *   - активирует модуль I2C1;
 *
 * После выполнения интерфейс полностью готов к использованию
 * низкоуровневыми функциями работы с MPU6050 (Start, WriteReg, ReadReg).
 */
void GY521_I2C1_Init(void);

#endif // GU521_INIT_H



// Подробная документация по инициализации I2C1 для модуля MPU6050 (GY-521).
//
// Данный файл не просто объявляет функцию — он объясняет,
// КАК работает интерфейс I2C1 внутри STM32F4,
// ЗАЧЕМ настраиваются конкретные регистры,
// и ПОЧЕМУ используются такие значения.
//
// ----------------------------------------------------------------------------
// 1. Аппаратная конфигурация линий
// ----------------------------------------------------------------------------
//
// Модуль I2C работает по физическому принципу «открытого стока».
// Это означает:
//
//   - Линии SDA и SCL никогда не вытягиваются вверх микроконтроллером.
//   - MCU может только тянуть линию в ноль (0).
//   - Единица (1) формируется внешней подтяжкой (pull-up).
//
// Поэтому:
//
//   PB8 (I2C1_SCL) → AF4, open-drain, pull-up
//   PB9 (I2C1_SDA) → AF4, open-drain, pull-up
//
// Почему AF4?
//   Каждая ножка STM32 может иметь до 16 альтернативных функций (AF0–AF15).
//   Для I2C1 стандартная функция — это AF4.
//
// Почему open-drain?
//   Потому что так требует протокол I2C.
//
// Почему нужна подтяжка?
//   Протокол определяет логическую «1» как разряженную линию,
//   которую держит pull-up, пока никто не тянет её в 0.
//
// Почему высокая скорость GPIO?
//   Чтобы уменьшить задержки фронтов на линиях SCL/SDA,
//   особенно на длинных проводах или высокой нагрузке.
//
// ----------------------------------------------------------------------------
// 2. Назначение регистров I2C
// ----------------------------------------------------------------------------
//
// ---- CR2 ----
//   CR2[5:0] содержит частоту APB1 в МГц.
//   Это НЕ частота шины I2C, а частота МК, питающего периферию I2C.
//
//   Пример: APB1 = 42 МГц → CR2 = 42.
//   Без этого модуль I2C не сможет корректно рассчитывать тайминги.
//
// ----------------------------------------------------------------------------
//
// ---- CCR ----
//   Регистр формирования временной диаграммы SCL.
//   Определяет длительность тактов I2C.
//
//   Формула для Standard Mode (100 kHz):
//       CCR = F_APB / (2 * F_I2C)
//
//   Где:
//       F_APB  – частота периферии APB1 (у нас 42 МГц)
//       F_I2C  – требуемая частота шины (100000 Гц)
//
//   То есть драйвер рассчитывает CCR:
//
//       CCR ≈ 42000000 / (2 * 100000) = 210
//
//   Аппаратные ограничения:
//
//       - CCR >= 4
//           (меньшие значения приводят к слишком высокой частоте)
//
//       - CCR <= 0xFFF (12 бит)
//           (максимальное значение, разрешённое регистром)
//
// ----------------------------------------------------------------------------
//
// ---- TRISE ----
//   Регистр компенсации «времени фронта» сигнала.
//
//   В I2C стандартный режим определяет максимальное время
//   перехода «низко → высоко».
//
//   Для Standard Mode (до 100 kHz):
//       TRISE = F_APB(MHz) + 1
//
//   Значит при F_APB = 42 МГц:
//       TRISE = 42 + 1 = 43
//
//   Это требуется для корректного определения момента,
//   когда сигнал на SDA/SCL считается устойчивым.
//
// ----------------------------------------------------------------------------
// 3. Пояснение параметров i2c_freq и i2c_speed
// ----------------------------------------------------------------------------
//
//   i2c_freq  – фактическая частота APB1 в Гц (42000000 Гц)
//   i2c_speed – желаемая частота I2C (100000 Гц → стандартный режим)
//
//   Эти параметры используются только для вычисления CCR.
//
// ----------------------------------------------------------------------------
// 4. Почему делается полный сброс I2C перед конфигурацией?
// ----------------------------------------------------------------------------
//
//   I2C может «зависнуть», если:
//     - slave удержал SDA в 0,
//     - произошёл недосформированный STOP,
//     - были сбои питания,
//     - внезапный разрыв проводов.
//
//   Сброс (CR1/CR2/CCR/TRISE=0) гарантирует:
//
//     * отсутствие застрявших флагов,
//     * чистый старт,
//     * предсказуемое состояние модуля.
//
// ----------------------------------------------------------------------------
// 5. ACK — зачем включаем заранее?
// ----------------------------------------------------------------------------
//
//   ACK управляет тем, как I2C реагирует при чтении байтов.
//   Если включён ACK:
//
//     - MCU автоматически отправляет “подтверждение” после каждого принятого байта,
//       что означает: «готов принять следующий байт».
//
//   Это критически важно для MPU6050,
//   поскольку он отправляет много последовательных данных.
//
// ----------------------------------------------------------------------------
// 6. Что делает функция GY521_I2C1_Init?
// ----------------------------------------------------------------------------
//
//   Она выполняет следующее:
//
//     (1) включает тактирование GPIOB и I2C1
//     (2) настраивает PB8/PB9 в режим AF4 / open-drain / pull-up / high-speed
//     (3) полностью сбрасывает I2C1
//     (4) прописывает частоту APB1 в CR2
//     (5) рассчитывает CCR (на основе 100 кГц)
//     (6) задаёт TRISE
//     (7) включает аппаратный ACK
//     (8) включает I2C (CR1.PE)
//     (9) выводит CR1 и CR2 через USART для диагностики
//
//   После выполнения:
//     → интерфейс готов к работе,
//     → можно выполнять START/STOP, запись и чтение регистров MPU6050.
//
// ----------------------------------------------------------------------------
//
// Данная функция вызывается один раз в main() перед инициализацией MPU6050.
//
// ----------------------------------------------------------------------------
//                  ПОЛНАЯ ИНИЦИАЛИЗАЦИЯ I2C1
// ----------------------------------------------------------------------------
