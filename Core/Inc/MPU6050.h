#ifndef MPU6050_H
#define MPU6050_H

#include <stdint.h>
#include "stm32f4xx.h"

/******************************************************************************
 *                         МОДУЛЬ MPU6050 — ПОЛНАЯ ДОКУМЕНТАЦИЯ
 *
 * Этот модуль реализует низкоуровневый драйвер для инерциального датчика
 * MPU6050 (акселерометр + гироскоп + температура).
 *
 * Драйвер рассчитан НА ПОЛНОСТЬЮ РУЧНОЕ УПРАВЛЕНИЕ I2C (регистры CR1/CR2/SR1/SR2).
 * Мы используем только однобайтовые операции чтения/записи.
 *
 * ----------------------------------------------------------------------------
 *                         ОБЩАЯ СХЕМА РАБОТЫ MPU6050
 * ----------------------------------------------------------------------------
 *
 * 1) Сначала вызываем GY521_I2C1_Init()  — инициализация физического интерфейса I2C.
 * 2) Затем вызываем MPU6050_Init()       — конфигурация датчика.
 * 3) Далее можно опрашивать данные:
 *       - MPU6050_ReadRaw()       — получить СЫРЫЕ значения (16-бит).
 *       - MPU6050_AccelLSB_to_g() — перевод акселя в g.
 *       - MPU6050_GyroLSB_to_dps()— перевод гироскопа в °/с.
 *       - MPU6050_TempLSB_to_C()  — температура.
 *
 * 4) Для проверки связи:
 *       - MPU6050_ReadWhoAmI()
 *
 * ----------------------------------------------------------------------------
 *                         КАК РАБОТАТЬ С ФУНКЦИЯМИ:
 * ----------------------------------------------------------------------------
 *
 *  ● void MPU6050_Init(void)
 *      - Выполняет полный reset MPU6050.
 *      - Переключает тактирование на PLL.
 *      - Устанавливает фильтр DLPF.
 *      - Настраивает sample rate (частоту выборки).
 *      - Устанавливает диапазоны гироскопа и акселерометра.
 *      - Включает прерывание «Data Ready» (опционально).
 *
 *    Вызывается ОДИН РАЗ перед началом работы датчика.
 *
 *    Если один из этапов инициализации не удался — в консоль выводится ошибка.
 *
 * ----------------------------------------------------------------------------
 *
 *  ● uint8_t MPU6050_ReadWhoAmI(void)
 *      - Читает регистр WHO_AM_I (0x75).
 *      - Вернёт ожидаемое значение — 0x68.
 *      - Удобно для проверки связи по I2C.
 *
 * ----------------------------------------------------------------------------
 *
 *  ● void MPU6050_ReadRaw(int16_t accel[3], int16_t gyro[3], int16_t *temp)
 *      - Читает последовательно 14 байтов:
 *             ACCEL_X/Y/Z (6 байт)
 *             TEMP (2 байта)
 *             GYRO_X/Y/Z (6 байт)
 *
 *      - Заполняет массивы accel[] и gyro[] шестнадцатибитными значениями.
 *      - Температуру пишет через указатель temp (если temp != NULL).
 *
 *      - Данные «сырые», без масштабирования.
 *      - Их необходимо переводить функциями ниже.
 *
 *    Вызов:
 *        int16_t acc[3], gyr[3], t;
 *        MPU6050_ReadRaw(acc, gyr, &t);
 *
 * ----------------------------------------------------------------------------
 *
 *  ● float MPU6050_AccelLSB_to_g(int16_t raw)
 *      - Конвертирует сырые данные акселерометра в единицы ускорения g.
 *      - Использует масштаб текущего диапазона (в данном драйвере: ±8g → 4096 LSB/g).
 *
 * ----------------------------------------------------------------------------
 *
 *  ● float MPU6050_GyroLSB_to_dps(int16_t raw)
 *      - Конвертирует сырые данные гироскопа в градусы/секунду.
 *      - Масштаб фиксирован на ±2000°/с → 16.4 LSB/dps.
 *
 * ----------------------------------------------------------------------------
 *
 *  ● float MPU6050_TempLSB_to_C(int16_t raw)
 *      - Преобразует температуру согласно даташиту.
 *      - Формула: T = 36.53 + raw/340.
 *
 * ----------------------------------------------------------------------------
 *
 *  ● void MPU6050_CalibrateGyro(float *bx, float *by, float *bz)
 *      - Производит программную калибровку гироскопа:
 *          * снимает N = 5000 сэмплов,
 *          * усредняет их,
 *          * выдаёт результаты в °/с.
 *
 *      - Этот оффсет можно вычитать из гироданных для уменьшения дрейфа.
 *
 * ----------------------------------------------------------------------------
 *                              ВАЖНЫЕ МОМЕНТЫ:
 * ----------------------------------------------------------------------------
 *
 *  ● Все функции основаны на СИНХРОННЫХ однобайтных операциях I2C.
 *      Это делает код стабильным, но не самым быстрым.
 *
 *  ● Драйвер НЕ использует DMA, FIFO или burst read.
 *
 *  ● MPU6050_ReadRaw() читает 14 регистров ПО ОДНОМУ БАЙТУ.
 *      → Работает всегда, но медленно.
 *      Если позже тебе нужен burst read — я напишу.
 *
 *  ● Драйвер предполагает:
 *        - AD0 = GND → адрес 0x68
 *        - питание датчика стабильное
 *        - линии I2C не зажаты внешними устройствами
 *
 ******************************************************************************/

/* ========== 7-битный адрес датчика (AD0 = GND) ========== */
#define MPU6050_ADDR 0x68

/* ========== Адреса регистров ========== */
#define MPU6050_REG_PWR_MGMT_1 0x6B
#define MPU6050_REG_SMPLRT_DIV 0x19
#define MPU6050_REG_CONFIG 0x1A
#define MPU6050_REG_GYRO_CONFIG 0x1B
#define MPU6050_REG_ACCEL_CONFIG 0x1C
#define MPU6050_REG_INT_PIN_CFG 0x37
#define MPU6050_REG_INT_ENABLE 0x38
#define MPU6050_REG_ACCEL_XOUT_H 0x3B
#define MPU6050_REG_WHO_AM_I 0x75

/* ========== Значения регистров ========== */

// Сброс устройства
#define MPU6050_DEVICE_RESET 0x80

// Тактовый источник — PLL по X-gyro (наиболее стабильный)
#define MPU6050_CLOCK_PLL_XGYRO 0x01

// Частота выборки: 1 kHz / (7 + 1) = 125 Hz
#define MPU6050_SMPLRT_7DIV 0x07

// Гироскоп: диапазон ±2000°/с
// Bits FS_SEL = 3 → (3 << 3) = 0x18
#define MPU6050_GYRO_CONFIG_2000 0x18

// Акселерометр: диапазон ±8g
#define MPU6050_ACCEL_CONFIG_8G 0x10

// Прерывание: Data Ready
#define MPU6050_INT_DATA_RDY 0x01

/******************************************************************************
 *                           ПРОТОТИПЫ ФУНКЦИЙ
 ******************************************************************************/

void MPU6050_Init(void);

/**
 * @brief Чтение WHO_AM_I (должно вернуть 0x68)
 */
uint8_t MPU6050_ReadWhoAmI(void);

/**
 * @brief Чтение сырых данных акселерометра/гироскопа/температуры
 *
 * @param accel [3] — ACCEL_X/Y/Z (int16)
 * @param gyro  [3] — GYRO_X/Y/Z  (int16)
 * @param temp      — TEMP_OUT    (int16)
 */
void MPU6050_ReadRaw(int16_t accel[3], int16_t gyro[3], int16_t *temp);

/**
 * @brief Перевод LSB в g (для диапазона ±8g)
 */
float MPU6050_AccelLSB_to_g(int16_t raw);

/**
 * @brief Перевод LSB гироскопа в °/с (для ±2000 dps)
 */
float MPU6050_GyroLSB_to_dps(int16_t raw);

/**
 * @brief Температура в °C
 */
float MPU6050_TempLSB_to_C(int16_t raw);

/**
 * @brief Калибровка гироскопа по N сэмплам (усреднение дрейфа)
 */
void MPU6050_CalibrateGyro(float *bias_x, float *bias_y, float *bias_z);

#endif
